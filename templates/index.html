<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firewall Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="text"], select {
            border: 1px solid #d1d5db;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Firewall Control Panel</h1>
        <p class="text-gray-600 mb-8">A web interface for managing iptables rules on this host.</p>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6 space-y-3">
            {% for category, message in messages %}
            <div
                class="p-4 rounded-md text-sm {% if category == 'error' %} bg-red-100 text-red-800 {% elif category == 'success' %} bg-green-100 text-green-800 {% else %} bg-blue-100 text-blue-800 {% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Add Rule Form -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4">Add a New Rule</h2>
            <form action="{{ url_for('add_rule') }}" method="POST"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                <div>
                    <label for="chain" class="block text-sm font-medium text-gray-700">Chain *</label>
                    <select id="chain" name="chain" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option>INPUT</option>
                        <option>OUTPUT</option>
                        <option>FORWARD</option>
                        {% for c in chains %}{% if c not in ['INPUT', 'OUTPUT', 'FORWARD'] %}<option>{{c}}</option>{%
                        endif %}{% endfor %}
                    </select>
                </div>

                <div>
                    <label for="source" class="block text-sm font-medium text-gray-700">Source IP/CIDR</label>
                    <input type="text" id="source" name="source" placeholder="e.g., 192.168.1.100"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>

                <div>
                    <label for="destination" class="block text-sm font-medium text-gray-700">Destination IP/CIDR</label>
                    <input type="text" id="destination" name="destination" placeholder="e.g., 8.8.8.8"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>

                <div>
                    <label for="protocol" class="block text-sm font-medium text-gray-700">Protocol</label>
                    <select id="protocol" name="protocol"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option value="">Any</option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="icmp">ICMP</option>
                    </select>
                </div>

                <div>
                    <label for="sport" class="block text-sm font-medium text-gray-700">Source Port</label>
                    <input type="text" id="sport" name="sport" placeholder="e.g., 8080"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>

                <div>
                    <label for="dport" class="block text-sm font-medium text-gray-700">Destination Port</label>
                    <input type="text" id="dport" name="dport" placeholder="e.g., 443"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>

                <div>
                    <label for="target" class="block text-sm font-medium text-gray-700">Target *</label>
                    <select id="target" name="target" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option>ACCEPT</option>
                        <option>DROP</option>
                        <option>REJECT</option>
                    </select>
                </div>

                <div class="flex items-end">
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add
                        Rule</button>
                </div>
            </form>
        </div>

        <!-- Current Rules Table -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Current Firewall Rules</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Chain</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Source</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Destination</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Protocol</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ports</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Target</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if not rules %}
                        <tr>
                            <td colspan="7" class="px-4 py-4 text-center text-gray-500">No rules defined in
                                configuration.</td>
                        </tr>
                        {% else %}
                        {% for rule in rules %}
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ rule.chain }}
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ rule.source or '-' }}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ rule.destination or '-' }}
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ rule.protocol or '-' }}
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                {% if rule.sport or rule.dport %}
                                S:{{ rule.sport or '*' }} &rarr; D:{{ rule.dport or '*' }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-bold 
                                {% if rule.target == 'ACCEPT' %}text-green-600
                                {% elif rule.target == 'DROP' %}text-red-600
                                {% elif rule.target == 'REJECT' %}text-yellow-600
                                {% endif %}">{{ rule.target }}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <form action="{{ url_for('delete_rule') }}" method="POST"
                                    onsubmit="return confirm('Are you sure you want to delete this rule?');">
                                    <input type="hidden" name="rule_index" value="{{ loop.index0 }}">
                                    <button type="submit" class="text-red-600 hover:text-red-900">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>

</html>