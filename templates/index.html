<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firewall Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        input[type="text"],
        select {
            border: 1px solid #d1d5db;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm mb-6">
        <div class="container mx-auto px-4 md:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-xl font-bold text-gray-900">Firewall Manager</h1>
                    <div class="flex space-x-4">
                        <a href="{{ url_for('index') }}"
                            class="px-3 py-2 rounded-md text-sm font-medium bg-indigo-100 text-indigo-700">
                            Rules
                        </a>
                        <a href="{{ url_for('connections') }}"
                            class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Connections
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        üë§ <span class="font-medium">{{ current_user.username }}</span>
                    </span>
                    <a href="{{ url_for('change_password') }}" class="text-sm text-gray-600 hover:text-gray-900">
                        Change Password
                    </a>
                    <a href="{{ url_for('logout') }}"
                        class="px-3 py-2 text-sm font-medium text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Firewall Rules</h2>
            <p class="text-gray-600">Manage iptables rules on this host</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6 space-y-3">
            {% for category, message in messages %}
            <div
                class="p-4 rounded-md text-sm flex items-start {% if category == 'error' %} bg-red-100 text-red-800 {% elif category == 'success' %} bg-green-100 text-green-800 {% else %} bg-blue-100 text-blue-800 {% endif %}">
                <span class="mr-2">
                    {% if category == 'error' %}‚ö†Ô∏è
                    {% elif category == 'success' %}‚úÖ
                    {% else %}‚ÑπÔ∏è
                    {% endif %}
                </span>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Default Policies Section -->
        <div
            class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg shadow-md mb-8 border border-purple-200">
            <h2 class="text-2xl font-semibold mb-4 text-purple-900">üõ°Ô∏è Default Chain Policies</h2>
            <p class="text-sm text-gray-600 mb-4">Set the default action for packets that don't match any rules.
                <strong>DROP</strong> is recommended for security.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- INPUT Policy -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-semibold text-gray-800 mb-3">INPUT Chain</h3>
                    <p class="text-xs text-gray-500 mb-3">Incoming packets to this host</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Current:
                            <span
                                class="font-bold px-2 py-1 rounded {% if policies.get('INPUT') == 'DROP' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ policies.get('INPUT', 'DROP') }}
                            </span>
                        </span>
                        <form action="{{ url_for('set_policy') }}" method="POST" class="inline">
                            <input type="hidden" name="chain" value="INPUT">
                            <select name="policy" class="text-sm border rounded p-1" onchange="this.form.submit()">
                                <option value="ACCEPT" {% if policies.get('INPUT')=='ACCEPT' %}selected{% endif %}>
                                    ACCEPT</option>
                                <option value="DROP" {% if policies.get('INPUT') !='ACCEPT' %}selected{% endif %}>DROP
                                </option>
                            </select>
                        </form>
                    </div>
                </div>

                <!-- OUTPUT Policy -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-semibold text-gray-800 mb-3">OUTPUT Chain</h3>
                    <p class="text-xs text-gray-500 mb-3">Outgoing packets from this host</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Current:
                            <span
                                class="font-bold px-2 py-1 rounded {% if policies.get('OUTPUT') == 'DROP' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ policies.get('OUTPUT', 'ACCEPT') }}
                            </span>
                        </span>
                        <form action="{{ url_for('set_policy') }}" method="POST" class="inline">
                            <input type="hidden" name="chain" value="OUTPUT">
                            <select name="policy" class="text-sm border rounded p-1" onchange="this.form.submit()">
                                <option value="ACCEPT" {% if policies.get('OUTPUT') !='DROP' %}selected{% endif %}>
                                    ACCEPT</option>
                                <option value="DROP" {% if policies.get('OUTPUT')=='DROP' %}selected{% endif %}>DROP
                                </option>
                            </select>
                        </form>
                    </div>
                </div>

                <!-- FORWARD Policy -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-semibold text-gray-800 mb-3">FORWARD Chain</h3>
                    <p class="text-xs text-gray-500 mb-3">Packets routed through this host</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Current:
                            <span
                                class="font-bold px-2 py-1 rounded {% if policies.get('FORWARD') == 'DROP' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ policies.get('FORWARD', 'DROP') }}
                            </span>
                        </span>
                        <form action="{{ url_for('set_policy') }}" method="POST" class="inline">
                            <input type="hidden" name="chain" value="FORWARD">
                            <select name="policy" class="text-sm border rounded p-1" onchange="this.form.submit()">
                                <option value="ACCEPT" {% if policies.get('FORWARD')=='ACCEPT' %}selected{% endif %}>
                                    ACCEPT</option>
                                <option value="DROP" {% if policies.get('FORWARD') !='ACCEPT' %}selected{% endif %}>DROP
                                </option>
                            </select>
                        </form>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
                <strong>‚ö†Ô∏è Note:</strong> Stateful firewall rules (ESTABLISHED, RELATED connections) are automatically
                applied before your custom rules.
            </div>
        </div>

        <!-- Add Rule Form -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4">‚ûï Add a New Rule</h2>
            <form action="{{ url_for('add_rule') }}" method="POST"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                <div>
                    <label for="chain" class="block text-sm font-medium text-gray-700">Chain *</label>
                    <select id="chain" name="chain" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option>INPUT</option>
                        <option>OUTPUT</option>
                        <option>FORWARD</option>
                        {% for c in chains %}{% if c not in ['INPUT', 'OUTPUT', 'FORWARD'] %}<option>{{c}}</option>{%
                        endif %}{% endfor %}
                    </select>
                </div>

                <div>
                    <label for="source" class="block text-sm font-medium text-gray-700">Source IP/CIDR</label>
                    <input type="text" id="source" name="source" placeholder="e.g., 192.168.1.0/24"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    <p class="text-xs text-gray-500 mt-1">Leave empty for any</p>
                </div>

                <div>
                    <label for="destination" class="block text-sm font-medium text-gray-700">Destination IP/CIDR</label>
                    <input type="text" id="destination" name="destination" placeholder="e.g., 8.8.8.8"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    <p class="text-xs text-gray-500 mt-1">Leave empty for any</p>
                </div>

                <div>
                    <label for="protocol" class="block text-sm font-medium text-gray-700">Protocol</label>
                    <select id="protocol" name="protocol"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option value="">Any</option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="icmp">ICMP</option>
                    </select>
                </div>

                <div>
                    <label for="sport" class="block text-sm font-medium text-gray-700">Source Port</label>
                    <input type="text" id="sport" name="sport" placeholder="e.g., 8080 or 1024:2048"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    <p class="text-xs text-gray-500 mt-1">Single or range</p>
                </div>

                <div>
                    <label for="dport" class="block text-sm font-medium text-gray-700">Destination Port</label>
                    <input type="text" id="dport" name="dport" placeholder="e.g., 443 or 80:443"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    <p class="text-xs text-gray-500 mt-1">Single or range</p>
                </div>

                <div>
                    <label for="target" class="block text-sm font-medium text-gray-700">Target *</label>
                    <select id="target" name="target" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option value="ACCEPT">ACCEPT</option>
                        <option value="DROP">DROP</option>
                        <option value="REJECT">REJECT</option>
                        <option value="LOG">LOG</option>
                    </select>
                </div>

                <div class="flex items-end">
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-medium">
                        ‚ûï Add Rule
                    </button>
                </div>
            </form>
        </div>

        <!-- Current Rules Table -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold">üìã Current Firewall Rules</h2>
                <span class="text-sm text-gray-500">{{ rules|length }} rule(s) defined</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Chain</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Source</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Destination</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Protocol</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ports</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Target</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if not rules %}
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <p class="font-medium">No custom rules defined</p>
                                    <p class="text-sm">Only stateful firewall rules are active</p>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        {% for rule in rules %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ loop.index }}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">{{
                                    rule.chain }}</span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 font-mono">{{ rule.source or
                                '0.0.0.0/0' }}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 font-mono">{{ rule.destination
                                or '0.0.0.0/0' }}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ rule.protocol|upper if rule.protocol else 'ALL' }}
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                                {% if rule.sport or rule.dport %}
                                <span class="text-xs">
                                    S:{{ rule.sport or '*' }} ‚Üí D:{{ rule.dport or '*' }}
                                </span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 py-1 rounded font-bold text-xs
                                    {% if rule.target == 'ACCEPT' %}bg-green-100 text-green-800
                                    {% elif rule.target == 'DROP' %}bg-red-100 text-red-800
                                    {% elif rule.target == 'REJECT' %}bg-orange-100 text-orange-800
                                    {% elif rule.target == 'LOG' %}bg-purple-100 text-purple-800
                                    {% endif %}">
                                    {{ rule.target }}
                                </span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <form action="{{ url_for('delete_rule') }}" method="POST" class="inline"
                                    onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to delete this rule?\n\nChain: {{ rule.chain }}\nTarget: {{ rule.target }}');">
                                    <input type="hidden" name="rule_index" value="{{ loop.index0 }}">
                                    <button type="submit"
                                        class="text-red-600 hover:text-red-900 hover:bg-red-50 px-3 py-1 rounded transition-colors">
                                        üóëÔ∏è Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-blue-50 border border-blue-200 p-6 rounded-lg">
            <h3 class="font-semibold text-blue-900 mb-3">üí° Quick Tips</h3>
            <ul class="text-sm text-blue-800 space-y-2">
                <li>‚Ä¢ <strong>Stateful rules</strong> are automatically applied: ESTABLISHED/RELATED connections are
                    accepted, INVALID packets are dropped</li>
                <li>‚Ä¢ Rules are evaluated in order. More specific rules should come before general ones</li>
                <li>‚Ä¢ Use <strong>CIDR notation</strong> for IP ranges: 192.168.1.0/24 matches 192.168.1.0-255</li>
                <li>‚Ä¢ Port ranges use colon: <code class="bg-white px-1 rounded">1024:2048</code></li>
                <li>‚Ä¢ A backup is automatically created before each change</li>
            </ul>
        </div>
    </div>

</body>

</html>
